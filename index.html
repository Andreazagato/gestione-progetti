<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Progetti</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            color: #333;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h1 {
            margin-bottom: 10px;
            color: #1a1a2e;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }

        .login-box .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-box input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .login-box input:focus {
            outline: none;
            border-color: #4361ee;
        }

        .login-box .btn {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
        }

        .login-error {
            color: #e74c3c;
            margin-bottom: 15px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Layout */
        .app-container {
            display: none;
            height: 100vh;
        }

        .app-container.active {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #1a1a2e;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #2d2d44;
        }

        .sidebar-header h1 {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: #2d2d44;
            color: white;
            font-size: 0.9rem;
        }

        .search-box::placeholder {
            color: #888;
        }

        .sidebar-nav {
            padding: 15px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 5px;
            transition: background 0.2s;
        }

        .nav-item:hover, .nav-item.active {
            background: #2d2d44;
        }

        .nav-item span {
            margin-left: 10px;
        }

        .nav-item .count {
            margin-left: auto;
            background: #4a4a6a;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .sidebar-section {
            padding: 15px;
            border-top: 1px solid #2d2d44;
        }

        .sidebar-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 10px;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 15px;
            border-top: 1px solid #2d2d44;
        }

        .logout-btn {
            width: 100%;
            padding: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-header h2 {
            font-size: 1.5rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4361ee;
            color: white;
        }

        .btn-primary:hover {
            background: #3651d4;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Projects Grid */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #4361ee;
        }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .project-card.stato-in_pausa {
            border-left-color: #f39c12;
        }

        .project-card.stato-completato {
            border-left-color: #27ae60;
        }

        .project-card.stato-archiviato {
            border-left-color: #95a5a6;
            opacity: 0.7;
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .project-card h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .project-card .cliente {
            font-size: 0.85rem;
            color: #666;
        }

        .project-card .stato-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .stato-badge.attivo { background: #e3f2fd; color: #1976d2; }
        .stato-badge.in_pausa { background: #fff3e0; color: #f57c00; }
        .stato-badge.completato { background: #e8f5e9; color: #388e3c; }
        .stato-badge.archiviato { background: #f5f5f5; color: #757575; }

        .project-card .percorso {
            font-size: 0.8rem;
            color: #888;
            margin: 10px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            word-break: break-all;
        }

        .project-card .task-summary {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
        }

        .task-summary span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Project Detail View */
        .project-detail {
            display: none;
        }

        .project-detail.active {
            display: block;
        }

        .detail-header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .detail-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .detail-header h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .detail-header .cliente-info {
            color: #666;
            font-size: 1rem;
        }

        .detail-actions {
            display: flex;
            gap: 10px;
        }

        .detail-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 0.95rem;
        }

        .info-item .value.percorso {
            word-break: break-all;
            cursor: pointer;
            color: #4361ee;
        }

        .info-item .value.percorso:hover {
            text-decoration: underline;
        }

        /* Notes Section */
        .notes-section, .credentials-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .notes-section h3, .credentials-section h3 {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-content {
            white-space: pre-wrap;
            line-height: 1.6;
            color: #555;
        }

        .notes-content:empty::before {
            content: "Nessuna nota";
            color: #999;
            font-style: italic;
        }

        /* Credentials List */
        .credentials-list {
            list-style: none;
        }

        .credential-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .credential-item:hover {
            border-color: #ddd;
            background: #fafafa;
        }

        .credential-icon {
            width: 40px;
            height: 40px;
            background: #4361ee;
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2rem;
        }

        .credential-content {
            flex: 1;
        }

        .credential-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .credential-details {
            font-size: 0.85rem;
            color: #666;
        }

        .credential-details span {
            margin-right: 15px;
        }

        .credential-actions {
            display: flex;
            gap: 5px;
        }

        .credential-actions button {
            padding: 8px 12px;
            border: none;
            background: #f0f0f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .credential-actions button:hover {
            background: #e0e0e0;
        }

        .credential-actions button.copy-btn {
            background: #e3f2fd;
            color: #1976d2;
        }

        .password-field {
            font-family: monospace;
            letter-spacing: 2px;
        }

        /* Tasks Section */
        .tasks-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tasks-header h3 {
            font-size: 1.2rem;
        }

        .task-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .task-filter {
            padding: 8px 16px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .task-filter.active {
            background: #4361ee;
            color: white;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .task-item:hover {
            border-color: #ddd;
            background: #fafafa;
        }

        .task-item.completato {
            opacity: 0.6;
        }

        .task-item.completato .task-title {
            text-decoration: line-through;
        }

        .task-item.ritardo {
            background: #fff5f5;
            border-color: #ffcccc;
        }

        .scadenza-tag {
            font-size: 0.8rem;
            color: #666;
        }

        .scadenza-tag.ritardo {
            color: #e74c3c;
            font-weight: 500;
        }

        .task-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #ddd;
            border-radius: 50%;
            margin-right: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .task-checkbox:hover {
            border-color: #4361ee;
        }

        .task-item.completato .task-checkbox {
            background: #27ae60;
            border-color: #27ae60;
            color: white;
        }

        .task-item.in_corso .task-checkbox {
            background: #f39c12;
            border-color: #f39c12;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .task-description {
            font-size: 0.85rem;
            color: #666;
        }

        .task-meta {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .task-priority {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .priority-1 { background: #ffebee; color: #c62828; }
        .priority-2 { background: #fff3e0; color: #ef6c00; }
        .priority-3 { background: #e8f5e9; color: #2e7d32; }

        .task-status-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .task-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .task-actions button {
            padding: 5px 10px;
            border: none;
            background: none;
            cursor: pointer;
            color: #888;
            font-size: 0.9rem;
        }

        .task-actions button:hover {
            color: #333;
        }

        /* Clienti View */
        .clienti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .cliente-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .cliente-card h3 {
            margin-bottom: 10px;
        }

        .cliente-card .info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .cliente-card .progetti-count {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
            color: #888;
        }

        .cliente-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4361ee;
        }

        .form-group .password-input-wrapper {
            position: relative;
        }

        .form-group .password-input-wrapper input {
            padding-right: 45px;
        }

        .form-group .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: #888;
        }

        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin-top: 10px;
            animation: slideIn 0.3s ease;
        }

        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Dashboard */
        .dashboard-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .dashboard-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .dashboard-section h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .dashboard-urgent {
            border-left: 4px solid #e74c3c;
        }

        .dashboard-urgent h3 {
            color: #e74c3c;
        }

        .dashboard-today {
            border-left: 4px solid #f39c12;
        }

        .dashboard-today h3 {
            color: #f39c12;
        }

        .dashboard-azioni {
            border-left: 4px solid #9b59b6;
        }

        .dashboard-azioni h3 {
            color: #9b59b6;
        }

        .dashboard-list {
            list-style: none;
        }

        .dashboard-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .dashboard-item:hover {
            border-color: #ddd;
            background: #fafafa;
        }

        .dashboard-item.ritardo {
            background: #fff5f5;
            border-color: #ffcccc;
        }

        .dashboard-item-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #ddd;
            border-radius: 50%;
            margin-right: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .dashboard-item-checkbox:hover {
            border-color: #27ae60;
            background: #e8f5e9;
        }

        .dashboard-item-content {
            flex: 1;
        }

        .dashboard-item-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .dashboard-item-meta {
            font-size: 0.8rem;
            color: #888;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .dashboard-item-meta .progetto-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .dashboard-item-meta .cliente-tag {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .dashboard-item-meta .priority-tag {
            padding: 2px 8px;
            border-radius: 4px;
        }

        .dashboard-item-meta .priority-tag.alta {
            background: #ffebee;
            color: #c62828;
        }

        .dashboard-item-meta .priority-tag.media {
            background: #fff3e0;
            color: #ef6c00;
        }

        .dashboard-item-meta .priority-tag.bassa {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .dashboard-item-meta .scadenza-tag {
            color: #666;
        }

        .dashboard-item-meta .scadenza-tag.ritardo {
            color: #e74c3c;
            font-weight: 500;
        }

        .dashboard-empty {
            text-align: center;
            padding: 20px;
            color: #999;
            font-style: italic;
        }

        .dashboard-section.hide-empty {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                height: 100%;
                z-index: 100;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üîê Gestione Progetti</h1>
            <p id="loginSubtitle">Inserisci la password per accedere</p>
            <div class="login-error" id="loginError">Password errata</div>
            <form id="loginForm">
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Password" required>
                </div>
                <div class="form-group" id="confirmPasswordGroup" style="display: none;">
                    <input type="password" id="confirmPassword" placeholder="Conferma password">
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn">Accedi</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>üìã Gestione Progetti</h1>
                <input type="text" class="search-box" placeholder="Cerca progetti..." id="searchBox">
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item active" data-view="dashboard">
                    <span>üè†</span>
                    <span>Dashboard</span>
                    <span class="count count-urgent" id="countUrgenti" style="display: none; background: #e74c3c;">0</span>
                </div>
                <div class="nav-item" data-view="progetti">
                    <span>üìÅ</span>
                    <span>Tutti i Progetti</span>
                    <span class="count" id="countProgetti">0</span>
                </div>
                <div class="nav-item" data-view="attivi">
                    <span>üîµ</span>
                    <span>Attivi</span>
                    <span class="count" id="countAttivi">0</span>
                </div>
                <div class="nav-item" data-view="in_pausa">
                    <span>üü°</span>
                    <span>In Pausa</span>
                    <span class="count" id="countPausa">0</span>
                </div>
                <div class="nav-item" data-view="completati">
                    <span>üü¢</span>
                    <span>Completati</span>
                    <span class="count" id="countCompletati">0</span>
                </div>
            </nav>

            <div class="sidebar-section">
                <h3>Gestione</h3>
                <div class="nav-item" data-view="clienti">
                    <span>üë•</span>
                    <span>Clienti</span>
                    <span class="count" id="countClienti">0</span>
                </div>
                <div class="nav-item" data-view="task_generali">
                    <span>üìù</span>
                    <span>Task Generali</span>
                    <span class="count" id="countTaskGenerali">0</span>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">üö™ Esci</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <h2 id="viewTitle">Tutti i Progetti</h2>
                <div>
                    <button class="btn btn-primary" id="btnNuovo">+ Nuovo Progetto</button>
                </div>
            </header>

            <div class="content-area">
                <!-- Dashboard View -->
                <div id="dashboardView" class="view-content">
                    <div class="dashboard-container">
                        <!-- Task in ritardo -->
                        <div class="dashboard-section dashboard-urgent">
                            <h3>üî¥ In Ritardo</h3>
                            <ul class="dashboard-list" id="dashboardRitardo">
                                <div class="loading">Caricamento...</div>
                            </ul>
                        </div>

                        <!-- Task oggi -->
                        <div class="dashboard-section dashboard-today">
                            <h3>üìÖ Oggi</h3>
                            <ul class="dashboard-list" id="dashboardOggi">
                                <div class="loading">Caricamento...</div>
                            </ul>
                        </div>

                        <!-- Task domani -->
                        <div class="dashboard-section">
                            <h3>üìÜ Domani</h3>
                            <ul class="dashboard-list" id="dashboardDomani">
                                <div class="loading">Caricamento...</div>
                            </ul>
                        </div>

                        <!-- Task questa settimana -->
                        <div class="dashboard-section">
                            <h3>üóìÔ∏è Questa Settimana</h3>
                            <ul class="dashboard-list" id="dashboardSettimana">
                                <div class="loading">Caricamento...</div>
                            </ul>
                        </div>

                        <!-- Task in corso senza scadenza -->
                        <div class="dashboard-section">
                            <h3>üîÑ In Corso</h3>
                            <ul class="dashboard-list" id="dashboardInCorso">
                                <div class="loading">Caricamento...</div>
                            </ul>
                        </div>

                        <!-- Azioni successive clienti -->
                        <div class="dashboard-section dashboard-azioni">
                            <h3>üí° Azioni Successive Clienti</h3>
                            <ul class="dashboard-list" id="dashboardAzioni">
                                <div class="loading">Caricamento...</div>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Projects List View -->
                <div id="projectsView" class="view-content" style="display: none;">
                    <div class="projects-grid" id="projectsGrid">
                        <div class="loading">Caricamento...</div>
                    </div>
                </div>

                <!-- Project Detail View -->
                <div id="projectDetailView" class="project-detail">
                    <!-- Populated dynamically -->
                </div>

                <!-- Clienti View -->
                <div id="clientiView" class="view-content" style="display: none;">
                    <div class="clienti-grid" id="clientiGrid">
                        <div class="loading">Caricamento...</div>
                    </div>
                </div>

                <!-- Cliente Detail View -->
                <div id="clienteDetailView" class="project-detail">
                    <!-- Populated dynamically -->
                </div>

                <!-- Task Generali View -->
                <div id="taskGeneraliView" class="view-content" style="display: none;">
                    <div class="task-filters" id="taskGeneraliFilters">
                        <button class="task-filter active" onclick="filterTaskGenerali('tutti', this)">Tutti</button>
                        <button class="task-filter" onclick="filterTaskGenerali('da_fare', this)">Da fare</button>
                        <button class="task-filter" onclick="filterTaskGenerali('in_corso', this)">In corso</button>
                        <button class="task-filter" onclick="filterTaskGenerali('completato', this)">Completati</button>
                    </div>
                    <ul class="task-list" id="taskGeneraliList">
                        <div class="loading">Caricamento...</div>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Nuovo/Modifica Progetto -->
    <div class="modal-overlay" id="modalProgetto">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalProgettoTitle">Nuovo Progetto</h3>
                <button class="modal-close" onclick="closeModal('modalProgetto')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formProgetto">
                    <input type="hidden" id="progettoId">
                    <div class="form-group">
                        <label>Nome Progetto *</label>
                        <input type="text" id="progettoNome" required>
                    </div>
                    <div class="form-group">
                        <label>Cliente</label>
                        <select id="progettoCliente">
                            <option value="">-- Nessun cliente --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stato</label>
                        <select id="progettoStato">
                            <option value="attivo">Attivo</option>
                            <option value="in_pausa">In Pausa</option>
                            <option value="completato">Completato</option>
                            <option value="archiviato">Archiviato</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Percorso Cartella</label>
                        <input type="text" id="progettoPercorso" placeholder="Es: C:\Progetti\NomeProgetto">
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea id="progettoNote" placeholder="Informazioni importanti, appunti, riferimenti..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalProgetto')">Annulla</button>
                <button class="btn btn-primary" onclick="salvaProgetto()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuovo/Modifica Task -->
    <div class="modal-overlay" id="modalTask">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTaskTitle">Nuovo Task</h3>
                <button class="modal-close" onclick="closeModal('modalTask')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formTask">
                    <input type="hidden" id="taskId">
                    <input type="hidden" id="taskProgettoId">
                    <div class="form-group">
                        <label>Titolo *</label>
                        <input type="text" id="taskTitolo" required>
                    </div>
                    <div class="form-group">
                        <label>Descrizione</label>
                        <textarea id="taskDescrizione" placeholder="Dettagli del task..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Priorit√†</label>
                        <select id="taskPriorita">
                            <option value="1">Alta</option>
                            <option value="2" selected>Media</option>
                            <option value="3">Bassa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stato</label>
                        <select id="taskStato">
                            <option value="da_fare">Da fare</option>
                            <option value="in_corso">In corso</option>
                            <option value="completato">Completato</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data Scadenza</label>
                        <input type="date" id="taskScadenza">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalTask')">Annulla</button>
                <button class="btn btn-primary" onclick="salvaTask()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuovo/Modifica Cliente -->
    <div class="modal-overlay" id="modalCliente">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalClienteTitle">Nuovo Cliente</h3>
                <button class="modal-close" onclick="closeModal('modalCliente')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formCliente">
                    <input type="hidden" id="clienteId">
                    <div class="form-group">
                        <label>Nome *</label>
                        <input type="text" id="clienteNome" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="clienteEmail">
                    </div>
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="text" id="clienteTelefono">
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea id="clienteNote" placeholder="Note sul cliente..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalCliente')">Annulla</button>
                <button class="btn btn-primary" onclick="salvaCliente()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuova/Modifica Credenziale -->
    <div class="modal-overlay" id="modalCredenziale">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalCredenzialeTitle">Nuova Credenziale</h3>
                <button class="modal-close" onclick="closeModal('modalCredenziale')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formCredenziale">
                    <input type="hidden" id="credenzialeId">
                    <input type="hidden" id="credenzialeProgettoId">
                    <input type="hidden" id="credenzialeClienteId">
                    <div class="form-group">
                        <label>Nome Servizio *</label>
                        <input type="text" id="credenzialeNome" placeholder="Es: Hosting, FTP, CPanel, WordPress..." required>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="text" id="credenzialeUrl" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="credenzialeUsername">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="credenzialePassword">
                            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('credenzialePassword', this)">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <textarea id="credenzialeNote" placeholder="Note aggiuntive..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalCredenziale')">Annulla</button>
                <button class="btn btn-primary" onclick="salvaCredenziale()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuovo/Modifica Task Generale -->
    <div class="modal-overlay" id="modalTaskGenerale">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTaskGeneraleTitle">Nuovo Task</h3>
                <button class="modal-close" onclick="closeModal('modalTaskGenerale')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formTaskGenerale">
                    <input type="hidden" id="taskGeneraleId">
                    <div class="form-group">
                        <label>Titolo *</label>
                        <input type="text" id="taskGeneraleTitolo" required>
                    </div>
                    <div class="form-group">
                        <label>Descrizione</label>
                        <textarea id="taskGeneraleDescrizione" placeholder="Dettagli del task..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Priorit√†</label>
                        <select id="taskGeneralePriorita">
                            <option value="1">Alta</option>
                            <option value="2" selected>Media</option>
                            <option value="3">Bassa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stato</label>
                        <select id="taskGeneraleStato">
                            <option value="da_fare">Da fare</option>
                            <option value="in_corso">In corso</option>
                            <option value="completato">Completato</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data Scadenza</label>
                        <input type="date" id="taskGeneraleScadenza">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalTaskGenerale')">Annulla</button>
                <button class="btn btn-primary" onclick="salvaTaskGenerale()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuova Azione Successiva Cliente -->
    <div class="modal-overlay" id="modalAzione">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalAzioneTitle">Nuova Azione</h3>
                <button class="modal-close" onclick="closeModal('modalAzione')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formAzione">
                    <input type="hidden" id="azioneId">
                    <input type="hidden" id="azioneClienteId">
                    <div class="form-group">
                        <label>Descrizione *</label>
                        <textarea id="azioneDescrizione" placeholder="Es: Richiamare per conferma, Inviare preventivo, Verificare pagamento..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Priorit√†</label>
                        <select id="azionePriorita">
                            <option value="1">Alta</option>
                            <option value="2" selected>Media</option>
                            <option value="3">Bassa</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalAzione')">Annulla</button>
                <button class="btn btn-primary" onclick="salvaAzione()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuova Attivit√† Cliente -->
    <div class="modal-overlay" id="modalAttivita">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalAttivitaTitle">Nuova Attivit√†</h3>
                <button class="modal-close" onclick="closeModal('modalAttivita')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formAttivita">
                    <input type="hidden" id="attivitaId">
                    <input type="hidden" id="attivitaClienteId">
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" id="attivitaData" required>
                    </div>
                    <div class="form-group">
                        <label>Descrizione Attivit√† *</label>
                        <textarea id="attivitaDescrizione" placeholder="Descrivi l'attivit√† svolta, chiamata, email, incontro..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('modalAttivita')">Annulla</button>
                <button class="btn btn-primary" onclick="salvaAttivita()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Configurazione Supabase
        const SUPABASE_URL = 'https://ppvejdsvtesojnbqhjdc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwdmVqZHN2dGVzb2puYnFoamRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTU2MDYsImV4cCI6MjA4NTY5MTYwNn0.m-IS4OAMwIxWXAwhivuzOzw5EQ99abVyQLS-fKowNhs';

        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Stato applicazione
        let progetti = [];
        let clienti = [];
        let taskGenerali = [];
        let azioniClienti = [];
        let allTasks = []; // Tutti i task per la dashboard
        let currentView = 'dashboard';
        let currentProjectId = null;
        let currentClienteId = null;
        let currentFilter = 'tutti';
        let currentTaskGeneraliFilter = 'tutti';
        let isFirstAccess = false;
        let encryptionKey = null; // Chiave di crittografia derivata dalla password

        // ==================== CRITTOGRAFIA ====================

        async function deriveKey(password) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );
            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: encoder.encode('gestione-progetti-salt-2024'),
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }

        async function encrypt(text) {
            if (!text || !encryptionKey) return text;
            try {
                const encoder = new TextEncoder();
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    encryptionKey,
                    encoder.encode(text)
                );
                const combined = new Uint8Array(iv.length + encrypted.byteLength);
                combined.set(iv);
                combined.set(new Uint8Array(encrypted), iv.length);
                return 'ENC:' + btoa(String.fromCharCode(...combined));
            } catch (e) {
                console.error('Errore crittografia:', e);
                return text;
            }
        }

        async function decrypt(encryptedText) {
            if (!encryptedText || !encryptionKey) return encryptedText;
            if (!encryptedText.startsWith('ENC:')) return encryptedText; // Non criptato
            try {
                const data = Uint8Array.from(atob(encryptedText.slice(4)), c => c.charCodeAt(0));
                const iv = data.slice(0, 12);
                const encrypted = data.slice(12);
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    encryptionKey,
                    encrypted
                );
                return new TextDecoder().decode(decrypted);
            } catch (e) {
                console.error('Errore decrittografia:', e);
                return '[Errore decrittografia]';
            }
        }

        // ==================== LOGIN ====================

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('loginPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('loginError');

            if (isFirstAccess) {
                // Prima configurazione
                if (password !== confirmPassword) {
                    errorEl.textContent = 'Le password non corrispondono';
                    errorEl.classList.add('show');
                    return;
                }
                if (password.length < 4) {
                    errorEl.textContent = 'La password deve avere almeno 4 caratteri';
                    errorEl.classList.add('show');
                    return;
                }

                try {
                    const hash = await hashPassword(password);
                    const { error } = await db
                        .from('app_settings')
                        .insert([{ id: 1, password_hash: hash }]);

                    if (error) throw error;

                    encryptionKey = await deriveKey(password);
                    sessionStorage.setItem('authenticated', 'true');
                    sessionStorage.setItem('_ep', btoa(password)); // Salva temporaneamente per la sessione
                    showApp();
                } catch (error) {
                    errorEl.textContent = 'Errore: ' + error.message;
                    errorEl.classList.add('show');
                }
            } else {
                // Login normale
                try {
                    const { data, error } = await db
                        .from('app_settings')
                        .select('password_hash')
                        .eq('id', 1)
                        .single();

                    if (error) throw error;

                    const hash = await hashPassword(password);
                    if (hash === data.password_hash) {
                        encryptionKey = await deriveKey(password);
                        sessionStorage.setItem('authenticated', 'true');
                        sessionStorage.setItem('_ep', btoa(password)); // Salva temporaneamente per la sessione
                        showApp();
                    } else {
                        errorEl.textContent = 'Password errata';
                        errorEl.classList.add('show');
                    }
                } catch (error) {
                    errorEl.textContent = 'Errore: ' + error.message;
                    errorEl.classList.add('show');
                }
            }
        });

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkAuth() {
            // Verifica se esiste gi√† una password
            try {
                const { data, error, count } = await db
                    .from('app_settings')
                    .select('id', { count: 'exact' });

                console.log('checkAuth result:', { data, error, count });

                if (error) {
                    console.error('Errore query:', error);
                    enableFirstAccess();
                } else if (!data || data.length === 0) {
                    // Nessuna password configurata - prima configurazione
                    console.log('Prima configurazione - nessuna password trovata');
                    enableFirstAccess();
                } else {
                    console.log('Password esistente trovata');
                }
            } catch (error) {
                console.error('Eccezione:', error);
                enableFirstAccess();
            }

            // Verifica sessione e ripristina chiave crittografia
            if (sessionStorage.getItem('authenticated') === 'true') {
                const savedPass = sessionStorage.getItem('_ep');
                if (savedPass) {
                    encryptionKey = await deriveKey(atob(savedPass));
                    showApp();
                } else {
                    // Sessione senza chiave, richiedi login
                    sessionStorage.removeItem('authenticated');
                }
            }
        }

        function enableFirstAccess() {
            isFirstAccess = true;
            document.getElementById('loginSubtitle').textContent = 'Configura una password per proteggere i tuoi dati';
            document.getElementById('confirmPasswordGroup').style.display = 'block';
            document.getElementById('loginBtn').textContent = 'Configura Password';
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            initApp();
        }

        function logout() {
            sessionStorage.removeItem('authenticated');
            sessionStorage.removeItem('_ep');
            encryptionKey = null;
            location.reload();
        }

        // ==================== INIT ====================

        async function initApp() {
            await loadClienti();
            await loadProgetti();
            await loadTaskGenerali();
            await loadAzioniClienti();
            await loadAllTasks();
            setupEventListeners();
            navigateTo('dashboard'); // Mostra dashboard come prima schermata
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });

        // Event Listeners
        function setupEventListeners() {
            // Navigazione sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const view = item.dataset.view;
                    navigateTo(view);
                });
            });

            // Bottone nuovo
            document.getElementById('btnNuovo').addEventListener('click', () => {
                if (currentView === 'clienti') {
                    openModalCliente();
                } else if (currentView === 'task_generali') {
                    openModalTaskGenerale();
                } else {
                    openModalProgetto();
                }
            });

            // Ricerca
            document.getElementById('searchBox').addEventListener('input', (e) => {
                filterProgetti(e.target.value);
            });
        }

        // Navigazione
        function navigateTo(view) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === view);
            });

            currentView = view;

            const btnNuovo = document.getElementById('btnNuovo');
            const viewTitle = document.getElementById('viewTitle');

            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('projectsView').style.display = 'none';
            document.getElementById('projectDetailView').classList.remove('active');
            document.getElementById('clientiView').style.display = 'none';
            document.getElementById('clienteDetailView').classList.remove('active');
            document.getElementById('taskGeneraliView').style.display = 'none';

            if (view === 'dashboard') {
                viewTitle.textContent = 'Dashboard';
                btnNuovo.style.display = 'none';
                document.getElementById('dashboardView').style.display = 'block';
                renderDashboard();
            } else if (view === 'clienti') {
                viewTitle.textContent = 'Clienti';
                btnNuovo.style.display = 'block';
                btnNuovo.textContent = '+ Nuovo Cliente';
                document.getElementById('clientiView').style.display = 'block';
                renderClienti();
            } else if (view === 'task_generali') {
                viewTitle.textContent = 'Task Generali';
                btnNuovo.style.display = 'block';
                btnNuovo.textContent = '+ Nuovo Task';
                document.getElementById('taskGeneraliView').style.display = 'block';
                renderTaskGenerali();
            } else {
                btnNuovo.style.display = 'block';
                btnNuovo.textContent = '+ Nuovo Progetto';
                document.getElementById('projectsView').style.display = 'block';

                switch(view) {
                    case 'progetti':
                        viewTitle.textContent = 'Tutti i Progetti';
                        currentFilter = 'tutti';
                        break;
                    case 'attivi':
                        viewTitle.textContent = 'Progetti Attivi';
                        currentFilter = 'attivo';
                        break;
                    case 'in_pausa':
                        viewTitle.textContent = 'Progetti in Pausa';
                        currentFilter = 'in_pausa';
                        break;
                    case 'completati':
                        viewTitle.textContent = 'Progetti Completati';
                        currentFilter = 'completato';
                        break;
                }
                renderProgetti();
            }
        }

        // Caricamento dati
        async function loadProgetti() {
            try {
                const { data, error } = await db
                    .from('progetti')
                    .select(`
                        *,
                        clienti (id, nome),
                        task (id, stato)
                    `)
                    .order('updated_at', { ascending: false });

                if (error) throw error;
                progetti = data || [];
                updateCounts();
                renderProgetti();
            } catch (error) {
                showToast('Errore nel caricamento progetti: ' + error.message, 'error');
            }
        }

        async function loadClienti() {
            try {
                const { data, error } = await db
                    .from('clienti')
                    .select('*')
                    .order('nome');

                if (error) throw error;
                clienti = data || [];
                updateClienteSelect();
                document.getElementById('countClienti').textContent = clienti.length;
            } catch (error) {
                showToast('Errore nel caricamento clienti: ' + error.message, 'error');
            }
        }

        // Aggiorna contatori
        function updateCounts() {
            const counts = {
                total: progetti.length,
                attivo: progetti.filter(p => p.stato === 'attivo').length,
                in_pausa: progetti.filter(p => p.stato === 'in_pausa').length,
                completato: progetti.filter(p => p.stato === 'completato').length
            };

            document.getElementById('countProgetti').textContent = counts.total;
            document.getElementById('countAttivi').textContent = counts.attivo;
            document.getElementById('countPausa').textContent = counts.in_pausa;
            document.getElementById('countCompletati').textContent = counts.completato;
        }

        // Render progetti
        function renderProgetti() {
            const grid = document.getElementById('projectsGrid');
            let filteredProgetti = progetti;

            if (currentFilter !== 'tutti') {
                filteredProgetti = progetti.filter(p => p.stato === currentFilter);
            }

            if (filteredProgetti.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>Nessun progetto</h3>
                        <p>Crea il tuo primo progetto cliccando sul bottone "+ Nuovo Progetto"</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredProgetti.map(progetto => {
                const taskCounts = {
                    da_fare: (progetto.task || []).filter(t => t.stato === 'da_fare').length,
                    in_corso: (progetto.task || []).filter(t => t.stato === 'in_corso').length,
                    completato: (progetto.task || []).filter(t => t.stato === 'completato').length
                };

                return `
                    <div class="project-card stato-${progetto.stato}" onclick="openProject('${progetto.id}')">
                        <div class="project-card-header">
                            <div>
                                <h3>${escapeHtml(progetto.nome)}</h3>
                                <div class="cliente">${progetto.clienti ? escapeHtml(progetto.clienti.nome) : 'Nessun cliente'}</div>
                            </div>
                            <span class="stato-badge ${progetto.stato}">${formatStato(progetto.stato)}</span>
                        </div>
                        ${progetto.percorso_cartella ? `<div class="percorso">üìÅ ${escapeHtml(progetto.percorso_cartella)}</div>` : ''}
                        <div class="task-summary">
                            <span>üìã ${taskCounts.da_fare} da fare</span>
                            <span>üîÑ ${taskCounts.in_corso} in corso</span>
                            <span>‚úÖ ${taskCounts.completato} completati</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filtra progetti per ricerca
        function filterProgetti(query) {
            const grid = document.getElementById('projectsGrid');
            const q = query.toLowerCase();

            const filtered = progetti.filter(p =>
                p.nome.toLowerCase().includes(q) ||
                (p.clienti && p.clienti.nome.toLowerCase().includes(q)) ||
                (p.note && p.note.toLowerCase().includes(q))
            );

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>Nessun risultato</h3>
                        <p>Nessun progetto corrisponde alla ricerca "${escapeHtml(query)}"</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(progetto => {
                const taskCounts = {
                    da_fare: (progetto.task || []).filter(t => t.stato === 'da_fare').length,
                    in_corso: (progetto.task || []).filter(t => t.stato === 'in_corso').length,
                    completato: (progetto.task || []).filter(t => t.stato === 'completato').length
                };

                return `
                    <div class="project-card stato-${progetto.stato}" onclick="openProject('${progetto.id}')">
                        <div class="project-card-header">
                            <div>
                                <h3>${escapeHtml(progetto.nome)}</h3>
                                <div class="cliente">${progetto.clienti ? escapeHtml(progetto.clienti.nome) : 'Nessun cliente'}</div>
                            </div>
                            <span class="stato-badge ${progetto.stato}">${formatStato(progetto.stato)}</span>
                        </div>
                        ${progetto.percorso_cartella ? `<div class="percorso">üìÅ ${escapeHtml(progetto.percorso_cartella)}</div>` : ''}
                        <div class="task-summary">
                            <span>üìã ${taskCounts.da_fare} da fare</span>
                            <span>üîÑ ${taskCounts.in_corso} in corso</span>
                            <span>‚úÖ ${taskCounts.completato} completati</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Apri dettaglio progetto
        async function openProject(id) {
            currentProjectId = id;
            currentClienteId = null;

            try {
                const { data: progetto, error } = await db
                    .from('progetti')
                    .select(`
                        *,
                        clienti (*),
                        task (*)
                    `)
                    .eq('id', id)
                    .single();

                if (error) throw error;

                // Carica credenziali del progetto
                const { data: credenziali } = await db
                    .from('credenziali')
                    .select('*')
                    .eq('progetto_id', id)
                    .order('nome_servizio');

                document.getElementById('dashboardView').style.display = 'none';
                document.getElementById('projectsView').style.display = 'none';
                document.getElementById('clientiView').style.display = 'none';
                document.getElementById('clienteDetailView').classList.remove('active');

                const detailView = document.getElementById('projectDetailView');
                detailView.classList.add('active');

                const tasks = progetto.task || [];
                tasks.sort((a, b) => {
                    const statoOrder = { 'in_corso': 0, 'da_fare': 1, 'completato': 2 };
                    if (statoOrder[a.stato] !== statoOrder[b.stato]) {
                        return statoOrder[a.stato] - statoOrder[b.stato];
                    }
                    return a.priorita - b.priorita;
                });

                // Renderizza credenziali (async)
                const credenzialiHtml = (credenziali || []).length === 0
                    ? `<div class="empty-state" style="padding: 30px;"><p>Nessuna credenziale salvata per questo progetto.</p></div>`
                    : (await Promise.all((credenziali || []).map(cred => renderCredentialItem(cred)))).join('');

                // Decripta note progetto
                const noteDecriptate = await decrypt(progetto.note);

                detailView.innerHTML = `
                    <div class="detail-header">
                        <div class="detail-header-top">
                            <div>
                                <button class="btn btn-secondary btn-small" onclick="backToList()">‚Üê Torna alla lista</button>
                                <h2 style="margin-top: 15px;">${escapeHtml(progetto.nome)}</h2>
                                <div class="cliente-info">
                                    ${progetto.clienti ? `üë§ ${escapeHtml(progetto.clienti.nome)}` : 'Nessun cliente associato'}
                                </div>
                            </div>
                            <div class="detail-actions">
                                <button class="btn btn-secondary" onclick="openModalProgetto('${progetto.id}')">‚úèÔ∏è Modifica</button>
                                <button class="btn btn-danger" onclick="eliminaProgetto('${progetto.id}')">üóëÔ∏è Elimina</button>
                            </div>
                        </div>
                        <div class="detail-info-grid">
                            <div class="info-item">
                                <label>Stato</label>
                                <div class="value">
                                    <span class="stato-badge ${progetto.stato}">${formatStato(progetto.stato)}</span>
                                </div>
                            </div>
                            <div class="info-item">
                                <label>Percorso Cartella</label>
                                <div class="value ${progetto.percorso_cartella ? 'percorso' : ''}"
                                     ${progetto.percorso_cartella ? `onclick="apriCartella('${escapeHtml(progetto.percorso_cartella)}')"` : ''}>
                                    ${progetto.percorso_cartella ? 'üìÅ ' + escapeHtml(progetto.percorso_cartella) : 'Non specificato'}
                                </div>
                            </div>
                            ${progetto.clienti ? `
                            <div class="info-item">
                                <label>Email Cliente</label>
                                <div class="value">${progetto.clienti.email || 'Non specificata'}</div>
                            </div>
                            <div class="info-item">
                                <label>Telefono Cliente</label>
                                <div class="value">${progetto.clienti.telefono || 'Non specificato'}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="notes-section">
                        <h3>
                            üìù Note e Informazioni
                            <button class="btn btn-secondary btn-small" onclick="openModalProgetto('${progetto.id}')">Modifica</button>
                        </h3>
                        <div class="notes-content">${noteDecriptate ? escapeHtml(noteDecriptate) : ''}</div>
                    </div>

                    <div class="credentials-section">
                        <h3>
                            üîê Credenziali (${(credenziali || []).length})
                            <button class="btn btn-primary btn-small" onclick="openModalCredenziale('progetto', '${progetto.id}')">+ Aggiungi</button>
                        </h3>
                        <ul class="credentials-list">
                            ${credenzialiHtml}
                        </ul>
                    </div>

                    <div class="tasks-section">
                        <div class="tasks-header">
                            <h3>‚úÖ Task (${tasks.length})</h3>
                            <button class="btn btn-primary btn-small" onclick="openModalTask()">+ Nuovo Task</button>
                        </div>

                        <div class="task-filters">
                            <button class="task-filter active" onclick="filterTasks('tutti', this)">Tutti</button>
                            <button class="task-filter" onclick="filterTasks('da_fare', this)">Da fare</button>
                            <button class="task-filter" onclick="filterTasks('in_corso', this)">In corso</button>
                            <button class="task-filter" onclick="filterTasks('completato', this)">Completati</button>
                        </div>

                        <ul class="task-list" id="taskList">
                            ${tasks.length === 0 ? `
                                <div class="empty-state">
                                    <p>Nessun task. Aggiungi il primo task per questo progetto.</p>
                                </div>
                            ` : tasks.map(task => renderTaskItem(task)).join('')}
                        </ul>
                    </div>
                `;

                document.getElementById('viewTitle').textContent = progetto.nome;

            } catch (error) {
                showToast('Errore nel caricamento del progetto: ' + error.message, 'error');
            }
        }

        // Render credential item
        async function renderCredentialItem(cred) {
            // Decripta i dati per la visualizzazione
            const decryptedUrl = await decrypt(cred.url);
            const decryptedUsername = await decrypt(cred.username);
            const decryptedNote = await decrypt(cred.note);
            // Password non viene mostrata, solo indicatore

            return `
                <li class="credential-item">
                    <div class="credential-icon">üîë</div>
                    <div class="credential-content">
                        <div class="credential-title">${escapeHtml(cred.nome_servizio)}</div>
                        <div class="credential-details">
                            ${decryptedUsername ? `<span>üë§ ${escapeHtml(decryptedUsername)}</span>` : ''}
                            ${cred.password ? `<span class="password-field">üîí ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>` : ''}
                            ${decryptedUrl ? `<span>üîó <a href="${escapeHtml(decryptedUrl)}" target="_blank">${escapeHtml(decryptedUrl)}</a></span>` : ''}
                        </div>
                        ${decryptedNote ? `<div style="font-size: 0.8rem; color: #888; margin-top: 5px;">${escapeHtml(decryptedNote)}</div>` : ''}
                    </div>
                    <div class="credential-actions">
                        ${decryptedUsername ? `<button class="copy-btn" onclick="copyCredential('${cred.id}', 'username')">üìã User</button>` : ''}
                        ${cred.password ? `<button class="copy-btn" onclick="copyCredential('${cred.id}', 'password')">üìã Pass</button>` : ''}
                        <button onclick="openModalCredenziale('edit', '${cred.id}')">‚úèÔ∏è</button>
                        <button onclick="eliminaCredenziale('${cred.id}')">üóëÔ∏è</button>
                    </div>
                </li>
            `;
        }

        async function copyCredential(credId, field) {
            try {
                const { data: cred, error } = await db
                    .from('credenziali')
                    .select(field)
                    .eq('id', credId)
                    .single();
                if (error) throw error;
                const decrypted = await decrypt(cred[field]);
                await navigator.clipboard.writeText(decrypted);
                showToast(`${field === 'username' ? 'Username' : 'Password'} copiato negli appunti!`, 'success');
            } catch (e) {
                showToast('Errore copia: ' + e.message, 'error');
            }
        }

        function copyToClipboard(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`${label} copiato negli appunti!`, 'success');
            });
        }

        function renderTaskItem(task) {
            const priorityLabels = { 1: 'Alta', 2: 'Media', 3: 'Bassa' };
            const isRitardo = task.data_scadenza && getDateCategory(task.data_scadenza) === 'ritardo';
            const scadenzaClass = isRitardo ? 'ritardo' : '';
            return `
                <li class="task-item ${task.stato} ${isRitardo && task.stato !== 'completato' ? 'ritardo' : ''}" data-stato="${task.stato}">
                    <div class="task-checkbox" onclick="toggleTaskStatus('${task.id}', '${task.stato}')">
                        ${task.stato === 'completato' ? '‚úì' : task.stato === 'in_corso' ? '‚óê' : ''}
                    </div>
                    <div class="task-content">
                        <div class="task-title">${escapeHtml(task.titolo)}</div>
                        ${task.descrizione ? `<div class="task-description">${escapeHtml(task.descrizione)}</div>` : ''}
                        <div class="task-meta">
                            <span class="task-priority priority-${task.priorita}">Priorit√†: ${priorityLabels[task.priorita]}</span>
                            ${task.data_scadenza ? `<span class="scadenza-tag ${scadenzaClass}">üìÖ ${formatData(task.data_scadenza)}</span>` : ''}
                            <select class="task-status-select" onchange="changeTaskStatus('${task.id}', this.value)">
                                <option value="da_fare" ${task.stato === 'da_fare' ? 'selected' : ''}>Da fare</option>
                                <option value="in_corso" ${task.stato === 'in_corso' ? 'selected' : ''}>In corso</option>
                                <option value="completato" ${task.stato === 'completato' ? 'selected' : ''}>Completato</option>
                            </select>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button onclick="openModalTask('${task.id}')" title="Modifica">‚úèÔ∏è</button>
                        <button onclick="eliminaTask('${task.id}')" title="Elimina">üóëÔ∏è</button>
                    </div>
                </li>
            `;
        }

        function filterTasks(stato, btn) {
            document.querySelectorAll('.task-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            document.querySelectorAll('.task-item').forEach(item => {
                if (stato === 'tutti' || item.dataset.stato === stato) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        async function toggleTaskStatus(id, currentStato) {
            const newStato = currentStato === 'completato' ? 'da_fare' :
                            currentStato === 'da_fare' ? 'in_corso' : 'completato';
            await changeTaskStatus(id, newStato);
        }

        async function changeTaskStatus(id, newStato) {
            try {
                const updateData = { stato: newStato };
                if (newStato === 'completato') {
                    updateData.completed_at = new Date().toISOString();
                } else {
                    updateData.completed_at = null;
                }

                const { error } = await db
                    .from('task')
                    .update(updateData)
                    .eq('id', id);

                if (error) throw error;

                await openProject(currentProjectId);
                showToast('Stato task aggiornato', 'success');
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        function backToList() {
            document.getElementById('projectDetailView').classList.remove('active');
            document.getElementById('clienteDetailView').classList.remove('active');
            currentProjectId = null;
            currentClienteId = null;
            navigateTo(currentView);
        }

        function apriCartella(percorso) {
            navigator.clipboard.writeText(percorso).then(() => {
                showToast('Percorso copiato negli appunti!', 'success');
            });
        }

        // Render clienti
        function renderClienti() {
            const grid = document.getElementById('clientiGrid');

            if (clienti.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>Nessun cliente</h3>
                        <p>Aggiungi il tuo primo cliente cliccando su "+ Nuovo Cliente"</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = clienti.map(cliente => {
                const progettiCliente = progetti.filter(p => p.cliente_id === cliente.id);
                return `
                    <div class="cliente-card" onclick="openCliente('${cliente.id}')" style="cursor: pointer;">
                        <h3>${escapeHtml(cliente.nome)}</h3>
                        ${cliente.email ? `<div class="info">üìß ${escapeHtml(cliente.email)}</div>` : ''}
                        ${cliente.telefono ? `<div class="info">üìû ${escapeHtml(cliente.telefono)}</div>` : ''}
                        <div class="progetti-count">üìÅ ${progettiCliente.length} progett${progettiCliente.length === 1 ? 'o' : 'i'}</div>
                    </div>
                `;
            }).join('');
        }

        // Apri dettaglio cliente
        async function openCliente(id) {
            currentClienteId = id;
            currentProjectId = null;

            try {
                const cliente = clienti.find(c => c.id === id);
                if (!cliente) throw new Error('Cliente non trovato');

                // Carica credenziali del cliente
                const { data: credenziali } = await db
                    .from('credenziali')
                    .select('*')
                    .eq('cliente_id', id)
                    .order('nome_servizio');

                // Carica storico attivit√† del cliente
                const { data: attivita } = await db
                    .from('attivita_cliente')
                    .select('*')
                    .eq('cliente_id', id)
                    .order('data', { ascending: false });

                // Carica azioni successive del cliente
                const { data: azioniCliente } = await db
                    .from('azioni_cliente')
                    .select('*')
                    .eq('cliente_id', id)
                    .eq('completata', false)
                    .order('priorita')
                    .order('created_at', { ascending: false });

                const progettiCliente = progetti.filter(p => p.cliente_id === id);

                document.getElementById('projectsView').style.display = 'none';
                document.getElementById('dashboardView').style.display = 'none';
                document.getElementById('clientiView').style.display = 'none';
                document.getElementById('projectDetailView').classList.remove('active');

                const detailView = document.getElementById('clienteDetailView');
                detailView.classList.add('active');

                // Renderizza credenziali cliente (async)
                const credenzialiClienteHtml = (credenziali || []).length === 0
                    ? `<div class="empty-state" style="padding: 30px;"><p>Nessuna credenziale salvata per questo cliente.</p></div>`
                    : (await Promise.all((credenziali || []).map(cred => renderCredentialItem(cred)))).join('');

                // Decripta note cliente
                const noteClienteDecriptate = await decrypt(cliente.note);

                detailView.innerHTML = `
                    <div class="detail-header">
                        <div class="detail-header-top">
                            <div>
                                <button class="btn btn-secondary btn-small" onclick="backToList()">‚Üê Torna alla lista</button>
                                <h2 style="margin-top: 15px;">üë§ ${escapeHtml(cliente.nome)}</h2>
                            </div>
                            <div class="detail-actions">
                                <button class="btn btn-secondary" onclick="openModalCliente('${cliente.id}')">‚úèÔ∏è Modifica</button>
                                <button class="btn btn-danger" onclick="eliminaCliente('${cliente.id}')">üóëÔ∏è Elimina</button>
                            </div>
                        </div>
                        <div class="detail-info-grid">
                            ${cliente.email ? `
                            <div class="info-item">
                                <label>Email</label>
                                <div class="value">${escapeHtml(cliente.email)}</div>
                            </div>
                            ` : ''}
                            ${cliente.telefono ? `
                            <div class="info-item">
                                <label>Telefono</label>
                                <div class="value">${escapeHtml(cliente.telefono)}</div>
                            </div>
                            ` : ''}
                            <div class="info-item">
                                <label>Progetti</label>
                                <div class="value">${progettiCliente.length} progett${progettiCliente.length === 1 ? 'o' : 'i'}</div>
                            </div>
                        </div>
                    </div>

                    ${noteClienteDecriptate ? `
                    <div class="notes-section">
                        <h3>üìù Note</h3>
                        <div class="notes-content">${escapeHtml(noteClienteDecriptate)}</div>
                    </div>
                    ` : ''}

                    <div class="credentials-section" style="border-left: 4px solid #9b59b6;">
                        <h3 style="color: #9b59b6;">
                            üí° Azioni Successive (${(azioniCliente || []).length})
                            <button class="btn btn-primary btn-small" onclick="openModalAzione()">+ Aggiungi</button>
                        </h3>
                        <ul class="credentials-list">
                            ${(azioniCliente || []).length === 0 ? `
                                <div class="empty-state" style="padding: 30px;">
                                    <p>Nessuna azione da fare per questo cliente.</p>
                                </div>
                            ` : (azioniCliente || []).map(az => renderAzioneItem(az)).join('')}
                        </ul>
                    </div>

                    <div class="credentials-section">
                        <h3>
                            üîê Credenziali Cliente (${(credenziali || []).length})
                            <button class="btn btn-primary btn-small" onclick="openModalCredenziale('cliente', '${cliente.id}')">+ Aggiungi</button>
                        </h3>
                        <ul class="credentials-list">
                            ${credenzialiClienteHtml}
                        </ul>
                    </div>

                    <div class="credentials-section">
                        <h3>
                            üìÖ Storico Attivit√† (${(attivita || []).length})
                            <button class="btn btn-primary btn-small" onclick="openModalAttivita()">+ Aggiungi</button>
                        </h3>
                        <ul class="credentials-list">
                            ${(attivita || []).length === 0 ? `
                                <div class="empty-state" style="padding: 30px;">
                                    <p>Nessuna attivit√† registrata per questo cliente.</p>
                                </div>
                            ` : (attivita || []).map(att => renderAttivitaItem(att)).join('')}
                        </ul>
                    </div>

                    ${progettiCliente.length > 0 ? `
                    <div class="tasks-section">
                        <h3>üìÅ Progetti del Cliente</h3>
                        <div class="projects-grid" style="margin-top: 15px;">
                            ${progettiCliente.map(progetto => `
                                <div class="project-card stato-${progetto.stato}" onclick="openProject('${progetto.id}')" style="margin-bottom: 0;">
                                    <div class="project-card-header">
                                        <h3>${escapeHtml(progetto.nome)}</h3>
                                        <span class="stato-badge ${progetto.stato}">${formatStato(progetto.stato)}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;

                document.getElementById('viewTitle').textContent = cliente.nome;

            } catch (error) {
                showToast('Errore nel caricamento del cliente: ' + error.message, 'error');
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        function updateClienteSelect() {
            const select = document.getElementById('progettoCliente');
            select.innerHTML = '<option value="">-- Nessun cliente --</option>' +
                clienti.map(c => `<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join('');
        }

        // Progetto modal
        async function openModalProgetto(id = null) {
            document.getElementById('modalProgettoTitle').textContent = id ? 'Modifica Progetto' : 'Nuovo Progetto';
            document.getElementById('progettoId').value = id || '';

            if (id) {
                const progetto = progetti.find(p => p.id === id);
                if (progetto) {
                    document.getElementById('progettoNome').value = progetto.nome;
                    document.getElementById('progettoCliente').value = progetto.cliente_id || '';
                    document.getElementById('progettoStato').value = progetto.stato;
                    document.getElementById('progettoPercorso').value = progetto.percorso_cartella || '';
                    document.getElementById('progettoNote').value = await decrypt(progetto.note) || '';
                }
            } else {
                document.getElementById('formProgetto').reset();
            }

            openModal('modalProgetto');
        }

        async function salvaProgetto() {
            const id = document.getElementById('progettoId').value;
            const noteVal = document.getElementById('progettoNote').value;
            const data = {
                nome: document.getElementById('progettoNome').value,
                cliente_id: document.getElementById('progettoCliente').value || null,
                stato: document.getElementById('progettoStato').value,
                percorso_cartella: document.getElementById('progettoPercorso').value || null,
                note: noteVal ? await encrypt(noteVal) : null,
                updated_at: new Date().toISOString()
            };

            try {
                if (id) {
                    const { error } = await db
                        .from('progetti')
                        .update(data)
                        .eq('id', id);
                    if (error) throw error;
                    showToast('Progetto aggiornato!', 'success');
                } else {
                    const { error } = await db
                        .from('progetti')
                        .insert([data]);
                    if (error) throw error;
                    showToast('Progetto creato!', 'success');
                }

                closeModal('modalProgetto');
                await loadProgetti();

                if (currentProjectId === id) {
                    await openProject(id);
                }
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        async function eliminaProgetto(id) {
            if (!confirm('Sei sicuro di voler eliminare questo progetto? Tutti i task e le credenziali associati verranno eliminati.')) {
                return;
            }

            try {
                const { error } = await db
                    .from('progetti')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showToast('Progetto eliminato', 'success');
                backToList();
                await loadProgetti();
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        // Task modal
        async function openModalTask(id = null) {
            document.getElementById('modalTaskTitle').textContent = id ? 'Modifica Task' : 'Nuovo Task';
            document.getElementById('taskId').value = id || '';
            document.getElementById('taskProgettoId').value = currentProjectId;

            if (id) {
                try {
                    const { data: task, error } = await db
                        .from('task')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    document.getElementById('taskTitolo').value = task.titolo;
                    document.getElementById('taskDescrizione').value = task.descrizione || '';
                    document.getElementById('taskPriorita').value = task.priorita;
                    document.getElementById('taskStato').value = task.stato;
                    document.getElementById('taskScadenza').value = task.data_scadenza || '';
                } catch (error) {
                    showToast('Errore: ' + error.message, 'error');
                    return;
                }
            } else {
                document.getElementById('formTask').reset();
                document.getElementById('taskPriorita').value = '2';
                document.getElementById('taskStato').value = 'da_fare';
                document.getElementById('taskScadenza').value = '';
            }

            openModal('modalTask');
        }

        async function salvaTask() {
            const id = document.getElementById('taskId').value;
            const data = {
                progetto_id: document.getElementById('taskProgettoId').value,
                titolo: document.getElementById('taskTitolo').value,
                descrizione: document.getElementById('taskDescrizione').value || null,
                priorita: parseInt(document.getElementById('taskPriorita').value),
                stato: document.getElementById('taskStato').value,
                data_scadenza: document.getElementById('taskScadenza').value || null
            };

            if (data.stato === 'completato') {
                data.completed_at = new Date().toISOString();
            }

            try {
                if (id) {
                    const { error } = await db
                        .from('task')
                        .update(data)
                        .eq('id', id);
                    if (error) throw error;
                    showToast('Task aggiornato!', 'success');
                } else {
                    const { error } = await db
                        .from('task')
                        .insert([data]);
                    if (error) throw error;
                    showToast('Task creato!', 'success');
                }

                closeModal('modalTask');
                await loadAllTasks();
                await openProject(currentProjectId);
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        async function eliminaTask(id) {
            if (!confirm('Sei sicuro di voler eliminare questo task?')) {
                return;
            }

            try {
                const { error } = await db
                    .from('task')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showToast('Task eliminato', 'success');
                await openProject(currentProjectId);
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        // Cliente modal
        async function openModalCliente(id = null) {
            document.getElementById('modalClienteTitle').textContent = id ? 'Modifica Cliente' : 'Nuovo Cliente';
            document.getElementById('clienteId').value = id || '';

            if (id) {
                const cliente = clienti.find(c => c.id === id);
                if (cliente) {
                    document.getElementById('clienteNome').value = cliente.nome;
                    document.getElementById('clienteEmail').value = cliente.email || '';
                    document.getElementById('clienteTelefono').value = cliente.telefono || '';
                    document.getElementById('clienteNote').value = await decrypt(cliente.note) || '';
                }
            } else {
                document.getElementById('formCliente').reset();
            }

            openModal('modalCliente');
        }

        async function salvaCliente() {
            const id = document.getElementById('clienteId').value;
            const noteVal = document.getElementById('clienteNote').value;
            const data = {
                nome: document.getElementById('clienteNome').value,
                email: document.getElementById('clienteEmail').value || null,
                telefono: document.getElementById('clienteTelefono').value || null,
                note: noteVal ? await encrypt(noteVal) : null
            };

            try {
                if (id) {
                    const { error } = await db
                        .from('clienti')
                        .update(data)
                        .eq('id', id);
                    if (error) throw error;
                    showToast('Cliente aggiornato!', 'success');
                } else {
                    const { error } = await db
                        .from('clienti')
                        .insert([data]);
                    if (error) throw error;
                    showToast('Cliente creato!', 'success');
                }

                closeModal('modalCliente');
                await loadClienti();
                await loadProgetti();

                if (currentClienteId === id) {
                    await openCliente(id);
                } else {
                    renderClienti();
                }
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        async function eliminaCliente(id) {
            const progettiAssociati = progetti.filter(p => p.cliente_id === id);
            if (progettiAssociati.length > 0) {
                if (!confirm(`Questo cliente ha ${progettiAssociati.length} progett${progettiAssociati.length === 1 ? 'o' : 'i'} associat${progettiAssociati.length === 1 ? 'o' : 'i'}. I progetti non verranno eliminati ma perderanno l'associazione. Continuare?`)) {
                    return;
                }
            } else {
                if (!confirm('Sei sicuro di voler eliminare questo cliente? Tutte le credenziali associate verranno eliminate.')) {
                    return;
                }
            }

            try {
                const { error } = await db
                    .from('clienti')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showToast('Cliente eliminato', 'success');
                backToList();
                await loadClienti();
                await loadProgetti();
                renderClienti();
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        // Credenziale modal
        async function openModalCredenziale(type, id) {
            document.getElementById('formCredenziale').reset();
            document.getElementById('credenzialeId').value = '';
            document.getElementById('credenzialeProgettoId').value = '';
            document.getElementById('credenzialeClienteId').value = '';
            document.getElementById('credenzialePassword').type = 'password';

            if (type === 'edit') {
                // Modifica credenziale esistente
                document.getElementById('modalCredenzialeTitle').textContent = 'Modifica Credenziale';
                try {
                    const { data: cred, error } = await db
                        .from('credenziali')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    document.getElementById('credenzialeId').value = cred.id;
                    document.getElementById('credenzialeProgettoId').value = cred.progetto_id || '';
                    document.getElementById('credenzialeClienteId').value = cred.cliente_id || '';
                    document.getElementById('credenzialeNome').value = cred.nome_servizio;
                    // Decripta i dati sensibili
                    document.getElementById('credenzialeUrl').value = await decrypt(cred.url) || '';
                    document.getElementById('credenzialeUsername').value = await decrypt(cred.username) || '';
                    document.getElementById('credenzialePassword').value = await decrypt(cred.password) || '';
                    document.getElementById('credenzialeNote').value = await decrypt(cred.note) || '';
                } catch (error) {
                    showToast('Errore: ' + error.message, 'error');
                    return;
                }
            } else if (type === 'progetto') {
                document.getElementById('modalCredenzialeTitle').textContent = 'Nuova Credenziale Progetto';
                document.getElementById('credenzialeProgettoId').value = id;
            } else if (type === 'cliente') {
                document.getElementById('modalCredenzialeTitle').textContent = 'Nuova Credenziale Cliente';
                document.getElementById('credenzialeClienteId').value = id;
            }

            openModal('modalCredenziale');
        }

        async function salvaCredenziale() {
            const id = document.getElementById('credenzialeId').value;
            const progettoId = document.getElementById('credenzialeProgettoId').value;
            const clienteId = document.getElementById('credenzialeClienteId').value;

            // Cripta i dati sensibili
            const urlVal = document.getElementById('credenzialeUrl').value;
            const userVal = document.getElementById('credenzialeUsername').value;
            const passVal = document.getElementById('credenzialePassword').value;
            const noteVal = document.getElementById('credenzialeNote').value;

            const data = {
                nome_servizio: document.getElementById('credenzialeNome').value,
                url: urlVal ? await encrypt(urlVal) : null,
                username: userVal ? await encrypt(userVal) : null,
                password: passVal ? await encrypt(passVal) : null,
                note: noteVal ? await encrypt(noteVal) : null
            };

            if (progettoId) {
                data.progetto_id = progettoId;
                data.cliente_id = null;
            } else if (clienteId) {
                data.cliente_id = clienteId;
                data.progetto_id = null;
            }

            try {
                if (id) {
                    const { error } = await db
                        .from('credenziali')
                        .update(data)
                        .eq('id', id);
                    if (error) throw error;
                    showToast('Credenziale aggiornata!', 'success');
                } else {
                    const { error } = await db
                        .from('credenziali')
                        .insert([data]);
                    if (error) throw error;
                    showToast('Credenziale salvata!', 'success');
                }

                closeModal('modalCredenziale');

                if (currentProjectId) {
                    await openProject(currentProjectId);
                } else if (currentClienteId) {
                    await openCliente(currentClienteId);
                }
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        async function eliminaCredenziale(id) {
            if (!confirm('Sei sicuro di voler eliminare questa credenziale?')) {
                return;
            }

            try {
                const { error } = await db
                    .from('credenziali')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showToast('Credenziale eliminata', 'success');

                if (currentProjectId) {
                    await openProject(currentProjectId);
                } else if (currentClienteId) {
                    await openCliente(currentClienteId);
                }
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        // Attivit√† cliente functions
        function renderAttivitaItem(att) {
            const dataFormatted = new Date(att.data).toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            return `
                <li class="credential-item">
                    <div class="credential-icon" style="background: #27ae60;">üìÖ</div>
                    <div class="credential-content">
                        <div class="credential-title">${dataFormatted}</div>
                        <div class="credential-details" style="white-space: pre-wrap;">${escapeHtml(att.descrizione)}</div>
                    </div>
                    <div class="credential-actions">
                        <button onclick="openModalAttivita('${att.id}')">‚úèÔ∏è</button>
                        <button onclick="eliminaAttivita('${att.id}')">üóëÔ∏è</button>
                    </div>
                </li>
            `;
        }

        async function openModalAttivita(id = null) {
            document.getElementById('modalAttivitaTitle').textContent = id ? 'Modifica Attivit√†' : 'Nuova Attivit√†';
            document.getElementById('attivitaId').value = id || '';
            document.getElementById('attivitaClienteId').value = currentClienteId;

            if (id) {
                try {
                    const { data: att, error } = await db
                        .from('attivita_cliente')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    document.getElementById('attivitaData').value = att.data;
                    document.getElementById('attivitaDescrizione').value = att.descrizione;
                } catch (error) {
                    showToast('Errore: ' + error.message, 'error');
                    return;
                }
            } else {
                document.getElementById('formAttivita').reset();
                // Imposta la data di oggi come default
                document.getElementById('attivitaData').value = new Date().toISOString().split('T')[0];
            }

            openModal('modalAttivita');
        }

        async function salvaAttivita() {
            const id = document.getElementById('attivitaId').value;
            const clienteId = document.getElementById('attivitaClienteId').value;

            const data = {
                cliente_id: clienteId,
                data: document.getElementById('attivitaData').value,
                descrizione: document.getElementById('attivitaDescrizione').value
            };

            try {
                if (id) {
                    const { error } = await db
                        .from('attivita_cliente')
                        .update(data)
                        .eq('id', id);
                    if (error) throw error;
                    showToast('Attivit√† aggiornata!', 'success');
                } else {
                    const { error } = await db
                        .from('attivita_cliente')
                        .insert([data]);
                    if (error) throw error;
                    showToast('Attivit√† salvata!', 'success');
                }

                closeModal('modalAttivita');
                await openCliente(currentClienteId);
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        async function eliminaAttivita(id) {
            if (!confirm('Sei sicuro di voler eliminare questa attivit√†?')) {
                return;
            }

            try {
                const { error } = await db
                    .from('attivita_cliente')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showToast('Attivit√† eliminata', 'success');
                await openCliente(currentClienteId);
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        // Utility functions
        function formatStato(stato) {
            const labels = {
                'attivo': 'Attivo',
                'in_pausa': 'In Pausa',
                'completato': 'Completato',
                'archiviato': 'Archiviato'
            };
            return labels[stato] || stato;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ==================== DASHBOARD ====================

        async function loadAllTasks() {
            try {
                // Carica tutti i task dei progetti con info progetto e cliente
                const { data, error } = await db
                    .from('task')
                    .select(`
                        *,
                        progetti (id, nome, cliente_id, clienti (id, nome))
                    `)
                    .neq('stato', 'completato')
                    .order('priorita');

                if (error) throw error;
                allTasks = data || [];
                updateUrgentCount();
            } catch (error) {
                showToast('Errore caricamento task: ' + error.message, 'error');
            }
        }

        async function loadAzioniClienti() {
            try {
                const { data, error } = await db
                    .from('azioni_cliente')
                    .select(`
                        *,
                        clienti (id, nome)
                    `)
                    .eq('completata', false)
                    .order('priorita')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                azioniClienti = data || [];
            } catch (error) {
                showToast('Errore caricamento azioni: ' + error.message, 'error');
            }
        }

        function updateUrgentCount() {
            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);

            // Conta task in ritardo + task oggi (progetti + task generali)
            let countUrgent = 0;

            // Task progetti
            allTasks.forEach(task => {
                if (task.data_scadenza) {
                    const scadenza = new Date(task.data_scadenza);
                    if (scadenza <= oggi) countUrgent++;
                }
            });

            // Task generali
            taskGenerali.filter(t => t.stato !== 'completato').forEach(task => {
                if (task.data_scadenza) {
                    const scadenza = new Date(task.data_scadenza);
                    if (scadenza <= oggi) countUrgent++;
                }
            });

            const countEl = document.getElementById('countUrgenti');
            if (countUrgent > 0) {
                countEl.textContent = countUrgent;
                countEl.style.display = 'inline';
            } else {
                countEl.style.display = 'none';
            }
        }

        function getDateCategory(dateStr) {
            if (!dateStr) return null;

            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);

            const domani = new Date(oggi);
            domani.setDate(domani.getDate() + 1);

            const fineSett = new Date(oggi);
            fineSett.setDate(fineSett.getDate() + 7);

            const data = new Date(dateStr);
            data.setHours(0, 0, 0, 0);

            if (data < oggi) return 'ritardo';
            if (data.getTime() === oggi.getTime()) return 'oggi';
            if (data.getTime() === domani.getTime()) return 'domani';
            if (data <= fineSett) return 'settimana';
            return 'futuro';
        }

        async function renderDashboard() {
            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);

            // Prepara i task suddivisi per categoria
            const taskRitardo = [];
            const taskOggi = [];
            const taskDomani = [];
            const taskSettimana = [];
            const taskInCorso = [];

            // Processa task dei progetti
            for (const task of allTasks) {
                const categoria = getDateCategory(task.data_scadenza);
                const item = {
                    id: task.id,
                    tipo: 'task_progetto',
                    titolo: task.titolo,
                    priorita: task.priorita,
                    stato: task.stato,
                    scadenza: task.data_scadenza,
                    progetto: task.progetti?.nome,
                    progettoId: task.progetti?.id,
                    cliente: task.progetti?.clienti?.nome
                };

                if (categoria === 'ritardo') taskRitardo.push(item);
                else if (categoria === 'oggi') taskOggi.push(item);
                else if (categoria === 'domani') taskDomani.push(item);
                else if (categoria === 'settimana') taskSettimana.push(item);
                else if (task.stato === 'in_corso') taskInCorso.push(item);
            }

            // Processa task generali
            for (const task of taskGenerali.filter(t => t.stato !== 'completato')) {
                const categoria = getDateCategory(task.data_scadenza);
                const item = {
                    id: task.id,
                    tipo: 'task_generale',
                    titolo: task.titolo,
                    priorita: task.priorita,
                    stato: task.stato,
                    scadenza: task.data_scadenza,
                    progetto: null,
                    cliente: null
                };

                if (categoria === 'ritardo') taskRitardo.push(item);
                else if (categoria === 'oggi') taskOggi.push(item);
                else if (categoria === 'domani') taskDomani.push(item);
                else if (categoria === 'settimana') taskSettimana.push(item);
                else if (task.stato === 'in_corso') taskInCorso.push(item);
            }

            // Ordina per priorit√†
            const sortByPriority = (a, b) => a.priorita - b.priorita;
            taskRitardo.sort(sortByPriority);
            taskOggi.sort(sortByPriority);
            taskDomani.sort(sortByPriority);
            taskSettimana.sort(sortByPriority);
            taskInCorso.sort(sortByPriority);

            // Render sezioni
            renderDashboardSection('dashboardRitardo', taskRitardo, 'Nessun task in ritardo');
            renderDashboardSection('dashboardOggi', taskOggi, 'Nessun task per oggi');
            renderDashboardSection('dashboardDomani', taskDomani, 'Nessun task per domani');
            renderDashboardSection('dashboardSettimana', taskSettimana, 'Nessun task questa settimana');
            renderDashboardSection('dashboardInCorso', taskInCorso, 'Nessun task in corso');

            // Render azioni clienti
            renderAzioniDashboard();

            // Nascondi sezioni vuote (tranne ritardo e oggi)
            toggleEmptySection('dashboardDomani', taskDomani.length);
            toggleEmptySection('dashboardSettimana', taskSettimana.length);
            toggleEmptySection('dashboardInCorso', taskInCorso.length);
        }

        function toggleEmptySection(containerId, count) {
            const section = document.getElementById(containerId).parentElement;
            if (count === 0) {
                section.classList.add('hide-empty');
            } else {
                section.classList.remove('hide-empty');
            }
        }

        function renderDashboardSection(containerId, items, emptyMessage) {
            const container = document.getElementById(containerId);

            if (items.length === 0) {
                container.innerHTML = `<div class="dashboard-empty">${emptyMessage}</div>`;
                return;
            }

            container.innerHTML = items.map(item => {
                const priorityLabels = { 1: 'Alta', 2: 'Media', 3: 'Bassa' };
                const priorityClass = { 1: 'alta', 2: 'media', 3: 'bassa' };
                const isRitardo = getDateCategory(item.scadenza) === 'ritardo';

                return `
                    <li class="dashboard-item ${isRitardo ? 'ritardo' : ''}" onclick="openTaskFromDashboard('${item.tipo}', '${item.id}', '${item.progettoId || ''}')">
                        <div class="dashboard-item-checkbox" onclick="event.stopPropagation(); completeDashboardTask('${item.tipo}', '${item.id}')">
                        </div>
                        <div class="dashboard-item-content">
                            <div class="dashboard-item-title">${escapeHtml(item.titolo)}</div>
                            <div class="dashboard-item-meta">
                                ${item.progetto ? `<span class="progetto-tag">üìÅ ${escapeHtml(item.progetto)}</span>` : ''}
                                ${item.cliente ? `<span class="cliente-tag">üë§ ${escapeHtml(item.cliente)}</span>` : ''}
                                ${item.tipo === 'task_generale' ? `<span class="progetto-tag">üìù Task Generale</span>` : ''}
                                <span class="priority-tag ${priorityClass[item.priorita]}">${priorityLabels[item.priorita]}</span>
                                ${item.scadenza ? `<span class="scadenza-tag ${isRitardo ? 'ritardo' : ''}">üìÖ ${formatData(item.scadenza)}</span>` : ''}
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
        }

        function renderAzioniDashboard() {
            const container = document.getElementById('dashboardAzioni');

            if (azioniClienti.length === 0) {
                container.innerHTML = `<div class="dashboard-empty">Nessuna azione da fare</div>`;
                const section = container.parentElement;
                section.classList.add('hide-empty');
                return;
            }

            container.parentElement.classList.remove('hide-empty');

            container.innerHTML = azioniClienti.map(azione => {
                const priorityLabels = { 1: 'Alta', 2: 'Media', 3: 'Bassa' };
                const priorityClass = { 1: 'alta', 2: 'media', 3: 'bassa' };

                return `
                    <li class="dashboard-item" onclick="openCliente('${azione.cliente_id}')">
                        <div class="dashboard-item-checkbox" onclick="event.stopPropagation(); completeAzione('${azione.id}')">
                        </div>
                        <div class="dashboard-item-content">
                            <div class="dashboard-item-title">${escapeHtml(azione.descrizione)}</div>
                            <div class="dashboard-item-meta">
                                <span class="cliente-tag">üë§ ${escapeHtml(azione.clienti?.nome || 'Cliente')}</span>
                                <span class="priority-tag ${priorityClass[azione.priorita]}">${priorityLabels[azione.priorita]}</span>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
        }

        async function openTaskFromDashboard(tipo, taskId, progettoId) {
            if (tipo === 'task_progetto' && progettoId) {
                await openProject(progettoId);
            } else if (tipo === 'task_generale') {
                navigateTo('task_generali');
            }
        }

        async function completeDashboardTask(tipo, taskId) {
            try {
                if (tipo === 'task_progetto') {
                    const { error } = await db
                        .from('task')
                        .update({ stato: 'completato', completed_at: new Date().toISOString() })
                        .eq('id', taskId);
                    if (error) throw error;
                } else if (tipo === 'task_generale') {
                    const { error } = await db
                        .from('task_generali')
                        .update({ stato: 'completato', completed_at: new Date().toISOString() })
                        .eq('id', taskId);
                    if (error) throw error;
                }

                showToast('Task completato!', 'success');
                await loadAllTasks();
                await loadTaskGenerali();
                renderDashboard();
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        async function completeAzione(azioneId) {
            try {
                const { error } = await db
                    .from('azioni_cliente')
                    .update({ completata: true, completed_at: new Date().toISOString() })
                    .eq('id', azioneId);

                if (error) throw error;

                showToast('Azione completata!', 'success');
                await loadAzioniClienti();
                renderDashboard();
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        // ==================== AZIONI CLIENTE ====================

        async function openModalAzione(id = null) {
            document.getElementById('modalAzioneTitle').textContent = id ? 'Modifica Azione' : 'Nuova Azione';
            document.getElementById('azioneId').value = id || '';
            document.getElementById('azioneClienteId').value = currentClienteId;

            if (id) {
                try {
                    const { data: azione, error } = await db
                        .from('azioni_cliente')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    document.getElementById('azioneDescrizione').value = azione.descrizione;
                    document.getElementById('azionePriorita').value = azione.priorita;
                } catch (error) {
                    showToast('Errore: ' + error.message, 'error');
                    return;
                }
            } else {
                document.getElementById('formAzione').reset();
                document.getElementById('azionePriorita').value = '2';
            }

            openModal('modalAzione');
        }

        async function salvaAzione() {
            const id = document.getElementById('azioneId').value;
            const clienteId = document.getElementById('azioneClienteId').value;

            const data = {
                cliente_id: clienteId,
                descrizione: document.getElementById('azioneDescrizione').value,
                priorita: parseInt(document.getElementById('azionePriorita').value)
            };

            try {
                if (id) {
                    const { error } = await db
                        .from('azioni_cliente')
                        .update(data)
                        .eq('id', id);
                    if (error) throw error;
                    showToast('Azione aggiornata!', 'success');
                } else {
                    const { error } = await db
                        .from('azioni_cliente')
                        .insert([data]);
                    if (error) throw error;
                    showToast('Azione salvata!', 'success');
                }

                closeModal('modalAzione');
                await loadAzioniClienti();
                await openCliente(currentClienteId);
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        async function eliminaAzione(id) {
            if (!confirm('Sei sicuro di voler eliminare questa azione?')) {
                return;
            }

            try {
                const { error } = await db
                    .from('azioni_cliente')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showToast('Azione eliminata', 'success');
                await loadAzioniClienti();
                await openCliente(currentClienteId);
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        function renderAzioneItem(azione) {
            const priorityLabels = { 1: 'Alta', 2: 'Media', 3: 'Bassa' };
            const priorityClass = { 1: 'alta', 2: 'media', 3: 'bassa' };

            return `
                <li class="credential-item">
                    <div class="credential-icon" style="background: #9b59b6;">üí°</div>
                    <div class="credential-content">
                        <div class="credential-title">${escapeHtml(azione.descrizione)}</div>
                        <div class="credential-details">
                            <span class="priority-tag ${priorityClass[azione.priorita]}">${priorityLabels[azione.priorita]}</span>
                        </div>
                    </div>
                    <div class="credential-actions">
                        <button onclick="completeAzioneFromCliente('${azione.id}')" style="background: #27ae60; color: white;">‚úì Fatto</button>
                        <button onclick="openModalAzione('${azione.id}')">‚úèÔ∏è</button>
                        <button onclick="eliminaAzione('${azione.id}')">üóëÔ∏è</button>
                    </div>
                </li>
            `;
        }

        async function completeAzioneFromCliente(azioneId) {
            try {
                const { error } = await db
                    .from('azioni_cliente')
                    .update({ completata: true, completed_at: new Date().toISOString() })
                    .eq('id', azioneId);

                if (error) throw error;

                showToast('Azione completata!', 'success');
                await loadAzioniClienti();
                await openCliente(currentClienteId);
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        // ==================== TASK GENERALI ====================

        async function loadTaskGenerali() {
            try {
                const { data, error } = await db
                    .from('task_generali')
                    .select('*')
                    .neq('stato', 'archiviato')
                    .order('priorita')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                taskGenerali = data || [];
                updateTaskGeneraliCount();
            } catch (error) {
                showToast('Errore nel caricamento task generali: ' + error.message, 'error');
            }
        }

        function updateTaskGeneraliCount() {
            const count = taskGenerali.filter(t => t.stato !== 'completato').length;
            document.getElementById('countTaskGenerali').textContent = count;
        }

        function renderTaskGenerali() {
            const list = document.getElementById('taskGeneraliList');
            let filtered = taskGenerali;

            if (currentTaskGeneraliFilter !== 'tutti') {
                filtered = taskGenerali.filter(t => t.stato === currentTaskGeneraliFilter);
            }

            // Ordina: in_corso prima, poi da_fare, poi completato. Poi per priorit√†
            filtered.sort((a, b) => {
                const statoOrder = { 'in_corso': 0, 'da_fare': 1, 'completato': 2 };
                if (statoOrder[a.stato] !== statoOrder[b.stato]) {
                    return statoOrder[a.stato] - statoOrder[b.stato];
                }
                return a.priorita - b.priorita;
            });

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>Nessun task</h3>
                        <p>Aggiungi il tuo primo task cliccando su "+ Nuovo Task"</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = filtered.map(task => renderTaskGeneraleItem(task)).join('');
        }

        function renderTaskGeneraleItem(task) {
            const priorityLabels = { 1: 'Alta', 2: 'Media', 3: 'Bassa' };
            const scadenzaHtml = task.data_scadenza ?
                `<span style="margin-left: 10px; color: ${isScaduto(task.data_scadenza) ? '#e74c3c' : '#888'};">
                    üìÖ ${formatData(task.data_scadenza)}
                </span>` : '';

            return `
                <li class="task-item ${task.stato}" data-stato="${task.stato}">
                    <div class="task-checkbox" onclick="toggleTaskGeneraleStatus('${task.id}', '${task.stato}')">
                        ${task.stato === 'completato' ? '‚úì' : task.stato === 'in_corso' ? '‚óê' : ''}
                    </div>
                    <div class="task-content">
                        <div class="task-title">${escapeHtml(task.titolo)}</div>
                        ${task.descrizione ? `<div class="task-description">${escapeHtml(task.descrizione)}</div>` : ''}
                        <div class="task-meta">
                            <span class="task-priority priority-${task.priorita}">Priorit√†: ${priorityLabels[task.priorita]}</span>
                            ${scadenzaHtml}
                            <select class="task-status-select" onchange="changeTaskGeneraleStatus('${task.id}', this.value)">
                                <option value="da_fare" ${task.stato === 'da_fare' ? 'selected' : ''}>Da fare</option>
                                <option value="in_corso" ${task.stato === 'in_corso' ? 'selected' : ''}>In corso</option>
                                <option value="completato" ${task.stato === 'completato' ? 'selected' : ''}>Completato</option>
                            </select>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button onclick="openModalTaskGenerale('${task.id}')" title="Modifica">‚úèÔ∏è</button>
                        <button onclick="eliminaTaskGenerale('${task.id}')" title="Elimina">üóëÔ∏è</button>
                    </div>
                </li>
            `;
        }

        function isScaduto(dataScadenza) {
            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);
            const scadenza = new Date(dataScadenza);
            return scadenza < oggi;
        }

        function formatData(data) {
            return new Date(data).toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function filterTaskGenerali(stato, btn) {
            document.querySelectorAll('#taskGeneraliFilters .task-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentTaskGeneraliFilter = stato;
            renderTaskGenerali();
        }

        async function toggleTaskGeneraleStatus(id, currentStato) {
            const newStato = currentStato === 'completato' ? 'da_fare' :
                            currentStato === 'da_fare' ? 'in_corso' : 'completato';
            await changeTaskGeneraleStatus(id, newStato);
        }

        async function changeTaskGeneraleStatus(id, newStato) {
            try {
                const updateData = { stato: newStato };
                if (newStato === 'completato') {
                    updateData.completed_at = new Date().toISOString();
                } else {
                    updateData.completed_at = null;
                }

                const { error } = await db
                    .from('task_generali')
                    .update(updateData)
                    .eq('id', id);

                if (error) throw error;

                await loadTaskGenerali();
                renderTaskGenerali();
                showToast('Stato task aggiornato', 'success');
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        async function openModalTaskGenerale(id = null) {
            document.getElementById('modalTaskGeneraleTitle').textContent = id ? 'Modifica Task' : 'Nuovo Task';
            document.getElementById('taskGeneraleId').value = id || '';

            if (id) {
                try {
                    const { data: task, error } = await db
                        .from('task_generali')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    document.getElementById('taskGeneraleTitolo').value = task.titolo;
                    document.getElementById('taskGeneraleDescrizione').value = task.descrizione || '';
                    document.getElementById('taskGeneralePriorita').value = task.priorita;
                    document.getElementById('taskGeneraleStato').value = task.stato;
                    document.getElementById('taskGeneraleScadenza').value = task.data_scadenza || '';
                } catch (error) {
                    showToast('Errore: ' + error.message, 'error');
                    return;
                }
            } else {
                document.getElementById('formTaskGenerale').reset();
                document.getElementById('taskGeneralePriorita').value = '2';
                document.getElementById('taskGeneraleStato').value = 'da_fare';
            }

            openModal('modalTaskGenerale');
        }

        async function salvaTaskGenerale() {
            const id = document.getElementById('taskGeneraleId').value;
            const data = {
                titolo: document.getElementById('taskGeneraleTitolo').value,
                descrizione: document.getElementById('taskGeneraleDescrizione').value || null,
                priorita: parseInt(document.getElementById('taskGeneralePriorita').value),
                stato: document.getElementById('taskGeneraleStato').value,
                data_scadenza: document.getElementById('taskGeneraleScadenza').value || null
            };

            if (data.stato === 'completato') {
                data.completed_at = new Date().toISOString();
            } else {
                data.completed_at = null;
            }

            try {
                if (id) {
                    const { error } = await db
                        .from('task_generali')
                        .update(data)
                        .eq('id', id);
                    if (error) throw error;
                    showToast('Task aggiornato!', 'success');
                } else {
                    const { error } = await db
                        .from('task_generali')
                        .insert([data]);
                    if (error) throw error;
                    showToast('Task creato!', 'success');
                }

                closeModal('modalTaskGenerale');
                await loadTaskGenerali();
                renderTaskGenerali();
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }

        async function eliminaTaskGenerale(id) {
            if (!confirm('Sei sicuro di voler eliminare questo task?')) {
                return;
            }

            try {
                const { error } = await db
                    .from('task_generali')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showToast('Task eliminato', 'success');
                await loadTaskGenerali();
                renderTaskGenerali();
            } catch (error) {
                showToast('Errore: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
